<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FE2C55">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081559.png">
    <link rel="manifest" href='data:application/manifest+json,{"name":"SampleTracker","short_name":"Samples","display":"standalone","background_color":"#FE2C55","theme_color":"#FE2C55","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3081/3081559.png","sizes":"512x512","type":"image/png"}]}'>

    <title>Sample Tracker Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --primary: #FE2C55; --dark: #121212; --bg: #F8F9FA; --surface: #FFFFFF; --green: #00C853; --yellow: #FFB300; --red: #FF3B30; --blue: #2196F3; --purple: #9C27B0; --border: #E0E0E0; --shadow: 0 4px 12px rgba(0,0,0,0.08); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--dark); padding-bottom: 20px; overflow-x: hidden; }
        
        .header { background: var(--surface); padding: 15px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header h1 { font-size: 1.3rem; font-weight: 800; }
        .header h1 span { color: var(--primary); }
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { background: none; border: none; font-size: 1.3rem; cursor: pointer; padding: 5px; }
        .add-sample-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 25px; font-weight: 700; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; width: 100%; justify-content: center; box-shadow: var(--shadow); transition: transform 0.2s; }
        .add-sample-btn:active { transform: scale(0.95); }
        
        .search-bar { width: 100%; padding: 10px 15px; border: 1.5px solid var(--border); border-radius: 25px; font-size: 0.9rem; background: #F9F9F9; }
        .container { max-width: 600px; margin: 0 auto; padding: 12px; }

        .view-toggle { display: flex; gap: 8px; margin-bottom: 12px; }
        .view-btn { flex: 1; padding: 12px 20px; border: 2px solid var(--border); background: var(--surface); border-radius: 25px; font-size: 0.9rem; font-weight: 700; cursor: pointer; transition: all 0.2s; color: #666; }
        .view-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .control-section { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .section-title { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: #999; margin-bottom: 10px; letter-spacing: 0.5px; }
        
        .filter-btn { padding: 10px 18px; border: 2px solid var(--border); background: var(--surface); border-radius: 25px; font-size: 0.85rem; font-weight: 700; color: #666; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .batch-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--dark); color: white; padding: 15px; display: none; justify-content: space-between; align-items: center; z-index: 99; box-shadow: 0 -4px 12px rgba(0,0,0,0.2); }
        .batch-bar.active { display: flex; }

        .sample-card { background: var(--surface); border-radius: 16px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .card-body { padding: 16px; position: relative; z-index: 2; }
        
        .brand-name { font-size: 0.75rem; color: #888; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .product-name { font-size: 1.1rem; font-weight: 700; color: var(--dark); margin: 4px 0 8px 0; line-height: 1.2; }
        
        .days-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 800; margin-bottom: 10px; }
        .days-badge.overdue { background: #FFEBEE; color: var(--red); }
        .days-badge.urgent { background: #FFF8E1; color: var(--yellow); }
        .days-badge.good { background: #E8F5E9; color: var(--green); }
        .days-badge.completed { background: #E0E0E0; color: #666; }
        
        .tag { padding: 3px 8px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; background: #E3F2FD; color: #1976D2; margin-right: 4px; }
        .notes-section { background: #FFFDE7; padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 10px; border-left: 3px solid var(--yellow); }
        
        .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #FAFAFA; padding: 12px; border-radius: 10px; font-size: 0.85rem; margin-bottom: 10px; }
        .meta-label { color: #888; font-size: 0.7rem; display: block; margin-bottom: 2px; font-weight: 600; }
        .meta-value { font-weight: 700; color: #333; }

        .progress-container { width: 100%; height: 8px; background: #eee; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.4s ease; }

        .row-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: transform 0.2s; }
        .btn-full-width { background: var(--primary); color: white; margin-bottom: 8px; }
        .btn-secondary { background: white; color: var(--dark); border: 1.5px solid var(--border); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 24px; padding: 24px; max-height: 90vh; overflow-y: auto; }
        
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-weight: 700; font-size: 0.85rem; margin-bottom: 6px; }
        .form-input, .form-textarea { width: 100%; padding: 12px; border: 1.5px solid #eee; border-radius: 12px; font-size: 1rem; background: #F9F9F9; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .calendar-day { aspect-ratio: 1; border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.75rem; cursor: pointer; background: white; }
        .calendar-day.has-items { background: #FFF3E0; border-color: var(--yellow); }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <h1><span>Sample</span> Tracker</h1>
            <div class="header-actions">
                <button class="icon-btn" onclick="openAnalytics()">üìä</button>
                <button class="icon-btn" onclick="toggleMenu()">‚ãÆ</button>
            </div>
        </div>
        <button class="add-sample-btn" onclick="openModal()">
            <span style="font-size: 1.2rem;">+</span>
            <span>Add New Sample</span>
        </button>
        
        <div class="view-toggle">
            <button class="view-btn active" id="view-list" onclick="setView('list')">üìã List</button>
            <button class="view-btn" id="view-calendar" onclick="setView('calendar')">üìÖ Calendar</button>
        </div>
        
        <input type="text" class="search-bar" id="searchBar" placeholder="Search brands..." oninput="render()">
    </div>
    
    <div class="container">
        <div id="listView">
            <div class="control-section">
                <div class="section-title">Filter</div>
                <div style="display: flex; gap: 8px; overflow-x: auto;">
                    <button class="filter-btn active" id="f-all" onclick="setFilter('all')">All</button>
                    <button class="filter-btn" id="f-overdue" onclick="setFilter('overdue')">üî• Overdue</button>
                    <button class="filter-btn" id="f-completed" onclick="setFilter('completed')">üèÅ Posted</button>
                </div>
            </div>
            <div id="sampleGrid"></div>
        </div>

        <div id="calendarView" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <button class="icon-btn" onclick="changeMonth(-1)">‚óÄ</button>
                <h2 id="calendarMonth"></h2>
                <button class="icon-btn" onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <div id="sampleModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-bottom:20px">Add Sample</h2>
            <form id="sampleForm" onsubmit="handleSave(event)">
                <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input type="text" id="productName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Brand</label>
                    <input type="text" id="brandName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Received Date</label>
                    <input type="date" id="dateReceived" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Days to Post</label>
                    <input type="number" id="daysLimit" class="form-input" value="14">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="notes" class="form-input" style="height:80px"></textarea>
                </div>
                <button type="submit" class="row-btn btn-full-width">Save Sample</button>
                <button type="button" class="row-btn btn-secondary" onclick="closeModal()">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        let samples = [];
        let currentFilter = 'all';
        let currentView = 'list';
        let editId = null;
        let currentCalendarMonth = new Date();
        let settings = { defaultDays: 14 };

        // Supabase Config
        const SUPABASE_URL = 'https://eiigbmrjtwndanywrcqp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpaWdibXJqdHduZGFueXdyY3FwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMDQyMzQsImV4cCI6MjA4Mjc4MDIzNH0.bHCDscs-aeSukDeXAf9kuRC12WBC3zSqIQia-8cIc3s';
        
        let sb_client = null;
        let currentUser = null;
        let useCloud = false;

        async function initSupabase() {
            try {
                if (typeof window.supabase === 'undefined') return;
                sb_client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const { data: { session } } = await sb_client.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    useCloud = true;
                    await loadFromCloud();
                } else {
                    await signInAnonymously();
                }
            } catch (e) {
                console.error('Supabase Init Error:', e);
            }
        }

        async function signInAnonymously() {
            let deviceId = localStorage.getItem('device_id') || 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('device_id', deviceId);
            const email = `${deviceId}@tracker.local`;
            const password = `Pass_${deviceId}`;

            let { data, error } = await sb_client.auth.signInWithPassword({ email, password });
            if (error) {
                let { data: upData, error: upErr } = await sb_client.auth.signUp({ email, password });
                if (!upErr) currentUser = upData.user;
            } else {
                currentUser = data.user;
            }
            if (currentUser) {
                useCloud = true;
                await loadFromCloud();
            }
        }

        async function saveSamples() {
            localStorage.setItem('tiktok_samples', JSON.stringify(samples));
            if (useCloud && currentUser) {
                await sb_client.from('sample_tracker_data').upsert({
                    user_id: currentUser.id,
                    samples: samples,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'user_id' });
            }
        }

        async function loadFromCloud() {
            const { data } = await sb_client.from('sample_tracker_data').select('samples').eq('user_id', currentUser.id).single();
            if (data && data.samples) {
                samples = data.samples;
                render();
            }
        }

        function getStatusInfo(s) {
            if (s.done) return { status: 'completed', text: 'Posted', color: '#666', days: 0, percent: 100 };
            const start = new Date(s.date + 'T00:00:00').getTime();
            const now = new Date().setHours(0,0,0,0);
            const due = start + (s.limit * 86400000);
            const diff = Math.ceil((due - now) / 86400000);
            if (diff < 0) return { status: 'overdue', text: `${Math.abs(diff)}d Overdue`, color: '#FF3B30', days: diff, percent: 100 };
            return { status: 'good', text: `${diff}d left`, color: '#00C853', days: diff, percent: 50 };
        }

        function render() {
            const grid = document.getElementById('sampleGrid');
            const search = document.getElementById('searchBar').value.toLowerCase();
            
            let filtered = samples.filter(s => {
                const matchesSearch = s.product.toLowerCase().includes(search) || s.brand.toLowerCase().includes(search);
                if (currentFilter === 'all') return matchesSearch && !s.done;
                if (currentFilter === 'completed') return matchesSearch && s.done;
                if (currentFilter === 'overdue') return matchesSearch && !s.done && getStatusInfo(s).status === 'overdue';
                return matchesSearch;
            });

            grid.innerHTML = filtered.map(s => {
                const info = getStatusInfo(s);
                return `
                <div class="sample-card">
                    <div class="card-body">
                        <div class="brand-name">${s.brand}</div>
                        <div class="product-name">${s.product}</div>
                        <div class="days-badge ${info.status}">${info.text}</div>
                        <div class="meta-grid">
                            <div><span class="meta-label">Received</span><span class="meta-value">${s.date}</span></div>
                            <div><span class="meta-label">Limit</span><span class="meta-value">${s.limit} days</span></div>
                        </div>
                        ${!s.done ? `<button class="row-btn btn-full-width" onclick="markDone('${s.id}')">Mark Posted</button>` : ''}
                        <button class="row-btn btn-secondary" onclick="openModal('${s.id}')">Edit</button>
                    </div>
                </div>`;
            }).join('');
        }

        function openModal(id = null) {
            editId = id;
            const form = document.getElementById('sampleForm');
            form.reset();
            if (id) {
                const s = samples.find(x => x.id === id);
                document.getElementById('productName').value = s.product;
                document.getElementById('brandName').value = s.brand;
                document.getElementById('dateReceived').value = s.date;
                document.getElementById('daysLimit').value = s.limit;
                document.getElementById('notes').value = s.notes || '';
            }
            document.getElementById('sampleModal').classList.add('active');
        }

        function closeModal() { document.getElementById('sampleModal').classList.remove('active'); }

        async function handleSave(e) {
            e.preventDefault();
            const newItem = {
                id: editId || Date.now().toString(),
                product: document.getElementById('productName').value,
                brand: document.getElementById('brandName').value,
                date: document.getElementById('dateReceived').value,
                limit: parseInt(document.getElementById('daysLimit').value),
                notes: document.getElementById('notes').value,
                done: editId ? samples.find(x => x.id === editId).done : false
            };
            if (editId) samples = samples.map(x => x.id === editId ? newItem : x);
            else samples.unshift(newItem);
            await saveSamples();
            render();
            closeModal();
        }

        async function markDone(id) {
            samples = samples.map(s => s.id === id ? {...s, done: true} : s);
            await saveSamples();
            render();
        }

        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.id === 'f-'+f));
            render();
        }

        function setView(v) {
            currentView = v;
            document.getElementById('listView').style.display = v === 'list' ? 'block' : 'none';
            document.getElementById('calendarView').style.display = v === 'calendar' ? 'block' : 'none';
            document.getElementById('view-list').classList.toggle('active', v === 'list');
            document.getElementById('view-calendar').classList.toggle('active', v === 'calendar');
            if (v === 'calendar') renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('calendarMonth');
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            monthDisplay.innerText = currentCalendarMonth.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let html = '';
            for (let day = 1; day <= daysInMonth; day++) {
                html += `<div class="calendar-day">${day}</div>`;
            }
            grid.innerHTML = html;
        }

        function changeMonth(d) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + d);
            renderCalendar();
        }

        window.onload = () => {
            const local = localStorage.getItem('tiktok_samples');
            if (local) samples = JSON.parse(local);
            render();
            initSupabase();
        };
    </script>
</body>
</html>












